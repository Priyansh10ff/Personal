<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WeatherWise Dashboard</title>
  <link href="https://fonts.googleapis.com" rel="preconnect" />
  <link crossorigin href="https://fonts.gstatic.com" rel="preconnect" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet" />
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""/>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

  <style type="text/tailwindcss">
    :root {
      --primary-color: #47a9eb;
      --secondary-color: #8e44ad;
      --accent-color: #f59e0b;
      --background-color: #0f172a;
      --card-background: #1f2937;
      --text-primary: #ffffff;
      --text-secondary: #9ca3af;
      --border-color: #374151;
      --success-color: #10b981;
    }
    .light {
      --primary-color: #2563eb;
      --secondary-color: #7c3aed;
      --accent-color: #f59e0b;
      --background-color: #f8fafc;
      --card-background: #ffffff;
      --text-primary: #0f172a;
      --text-secondary: #6b7280;
      --border-color: #e6edf3;
      --success-color: #059669;
    }
    
    /* Weather-specific background variables */
    :root {
      --weather-bg-1: #0f172a;
      --weather-bg-2: #1e293b;
    }
    
    body { 
      font-family: "Space Grotesk", sans-serif;
      background: linear-gradient(to bottom, var(--weather-bg-1), var(--weather-bg-2));
      min-height: 100vh;
      transition: background 1.5s ease;
    }
    .light body {
      background: linear-gradient(to bottom, var(--weather-bg-1), var(--weather-bg-2));
    }

    .card {
      border-radius: 1.5rem;
      padding: 1.75rem;
      background: var(--card-background);
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      box-shadow: 0 8px 25px rgba(2,6,23,0.5);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      overflow: hidden;
      position: relative;
    }
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      opacity: 0.8;
    }
    .card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 25px 50px rgba(2,6,23,0.6);
    }

    #cityName {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }
    #temp {
      background: linear-gradient(90deg, var(--accent-color), #ef4444);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      color: transparent;
    }

    .fade-in { 
      opacity: 0; 
      transform: translateY(20px); 
      transition: all 0.6s ease-out; 
    }
    .fade-in.show { 
      opacity: 1; 
      transform: translateY(0); 
    }

    /* Animations */
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    @keyframes spin-slow {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(71, 169, 235, 0.5); }
      50% { box-shadow: 0 0 40px rgba(71, 169, 235, 0.8), 0 0 60px rgba(71, 169, 235, 0.6); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    .float-animation {
      animation: float 6s ease-in-out infinite;
    }
    .pulse-animation {
      animation: pulse 3s ease-in-out infinite;
    }
    .spin-slow {
      animation: spin-slow 20s linear infinite;
    }
    .glow-animation {
      animation: glow 4s ease-in-out infinite;
    }
    .shake-animation {
      animation: shake 0.5s ease-in-out;
    }

    /* -- New Search Box Animation -- */
    .search-group {
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .anim-layer {
        position: absolute;
        z-index: -1;
        overflow: hidden;
        height: 100%;
        width: 100%;
    }

    .anim-layer::before {
        content: '';
        position: absolute;
        z-index: -2;
        background-repeat: no-repeat;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        transition: all 2s;
    }
    
    /* Layer 1 */
    .anim-layer-1 { max-height: 70px; max-width: 314px; border-radius: 0.75rem; filter: blur(3px); }
    .anim-layer-1::before {
        width: 999px; height: 999px;
        background-image: conic-gradient(#000, #402fb5 5%, #000 38%, #000 50%, #cf30aa 60%, #000 87%);
        transform: translate(-50%, -50%) rotate(60deg);
    }
    .search-group:hover .anim-layer-1::before { transform: translate(-50%, -50%) rotate(-120deg); }
    .search-group:focus-within .anim-layer-1::before { transform: translate(-50%, -50%) rotate(420deg); transition-duration: 4s; }

    /* Layer 2, 3, 4 */
    .anim-layer-2, .anim-layer-3, .anim-layer-4 { max-height: 65px; max-width: 312px; border-radius: 0.75rem; filter: blur(3px); }
    .anim-layer-2::before, .anim-layer-3::before, .anim-layer-4::before {
        width: 600px; height: 600px;
        background-image: conic-gradient(rgba(0,0,0,0), #18116a, rgba(0,0,0,0) 10%, rgba(0,0,0,0) 50%, #6e1b60, rgba(0,0,0,0) 60%);
        transform: translate(-50%, -50%) rotate(82deg);
    }
    .search-group:hover .anim-layer-2::before, .search-group:hover .anim-layer-3::before, .search-group:hover .anim-layer-4::before { transform: translate(-50%, -50%) rotate(-98deg); }
    .search-group:focus-within .anim-layer-2::before, .search-group:focus-within .anim-layer-3::before, .search-group:focus-within .anim-layer-4::before { transform: translate(-50%, -50%) rotate(442deg); transition-duration: 4s; }

    /* Layer 5 */
    .anim-layer-5 { max-height: 63px; max-width: 307px; border-radius: 0.5rem; filter: blur(2px); }
    .anim-layer-5::before {
        width: 600px; height: 600px;
        background-image: conic-gradient(rgba(0,0,0,0) 0%, #a099d8, rgba(0,0,0,0) 8%, rgba(0,0,0,0) 50%, #dfa2da, rgba(0,0,0,0) 58%);
        filter: brightness(1.4);
        transform: translate(-50%, -50%) rotate(83deg);
    }
    .search-group:hover .anim-layer-5::before { transform: translate(-50%, -50%) rotate(-97deg); }
    .search-group:focus-within .anim-layer-5::before { transform: translate(-50%, -50%) rotate(443deg); transition-duration: 4s; }

    /* Layer 6 */
    .anim-layer-6 { max-height: 59px; max-width: 303px; border-radius: 0.75rem; filter: blur(0.5px); }
    .anim-layer-6::before {
        width: 600px; height: 600px;
        background-image: conic-gradient(#1c191c, #402fb5 5%, #1c191c 14%, #1c191c 50%, #cf30aa 60%, #1c191c 64%);
        filter: brightness(1.3);
        transform: translate(-50%, -50%) rotate(70deg);
    }
    .search-group:hover .anim-layer-6::before { transform: translate(-50%, -50%) rotate(-110deg); }
    .search-group:focus-within .anim-layer-6::before { transform: translate(-50%, -50%) rotate(430deg); transition-duration: 4s; }
    
    #animated-search-box {
        position: relative;
    }

    #cityInput.animated {
        background-color: #010201;
        border: none;
        width: 301px;
        height: 56px;
        border-radius: 0.5rem;
        color: white;
        padding-left: 59px;
        padding-right: 50px; /* Space for the icon */
        font-size: 1rem;
    }
    #cityInput.animated:focus {
        outline: none;
        box-shadow: none; /* Override existing focus styles */
        transform: none; /* Override existing focus styles */
    }
    #cityInput.animated::placeholder {
        color: #9ca3af;
    }
    
    #search-icon {
        position: absolute;
        left: 20px;
        top: 15px;
        pointer-events: none;
    }

    /* Scroll animations */
    .scroll-fade-in {
      opacity: 0;
      transform: translateY(50px);
      transition: opacity 0.8s ease, transform 0.8s ease;
    }
    .scroll-fade-in.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Weather condition backgrounds */
    .weather-bg {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.05;
      z-index: -1;
      background-size: contain;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Forecast cards */
    .forecast-card {
      transition: all 0.3s ease;
      border-left: 3px solid var(--primary-color);
    }
    .forecast-card:hover {
      transform: translateX(5px);
      background: linear-gradient(90deg, rgba(71,169,235,0.1), transparent);
    }

    /* small utility for visually-hidden text */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }

    /* Custom scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: var(--card-background);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 10px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: var(--secondary-color);
    }
    
    /* Map Styles */
    #map {
      height: 400px;
      border-radius: 1rem;
      z-index: 1;
    }
    .leaflet-control-attribution {
      background: rgba(0, 0, 0, 0.5) !important;
      color: white;
    }
    .light .leaflet-control-attribution {
      background: rgba(255, 255, 255, 0.7) !important;
      color: black;
    }
    .weather-marker {
      background: transparent;
      border: none;
    }
    .map-temp-label {
      font-weight: bold;
      text-shadow: 0 0 3px rgba(0, 0, 0, 0.7);
      font-size: 14px;
    }
    .map-toggle {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: var(--card-background);
      border-radius: 4px;
      padding: 5px;
      display: flex;
      gap: 5px;
    }
    .map-toggle-btn {
      background: var(--card-background);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    .map-toggle-btn.active {
      background: var(--primary-color);
      color: white;
    }
    
    /* Planner Styles */
    .planner-item {
      border-left: 3px solid var(--primary-color);
      transition: all 0.3s ease;
    }
    .planner-item:hover {
      transform: translateX(5px);
      background: linear-gradient(90deg, rgba(71,169,235,0.1), transparent);
    }
    .weather-appropriate {
      border-left-color: var(--success-color);
    }
    .weather-caution {
      border-left-color: var(--accent-color);
    }
    .weather-inappropriate {
      border-left-color: #ef4444;
    }
    .activity-suggestion {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .activity-suggestion:hover {
      transform: scale(1.05);
      background: linear-gradient(90deg, rgba(71,169,235,0.15), transparent);
    }
    
    /* Weather particles */
    .weather-particle {
      position: fixed;
      pointer-events: none;
      z-index: -1;
    }
    
    /* Snowflakes */
    .snowflake {
      position: fixed;
      color: #fff;
      font-size: 1em;
      pointer-events: none;
      opacity: 0.8;
      animation: fall linear infinite;
      z-index: -1;
    }
    
    @keyframes fall {
      to {
        transform: translateY(105vh) rotate(360deg);
      }
    }
    
    /* Raindrops */
    .raindrop {
      position: fixed;
      background: linear-gradient(to bottom, rgba(255,255,255,0.3), rgba(255,255,255,0.1));
      width: 2px;
      height: 25px;
      pointer-events: none;
      animation: rainfall linear infinite;
      z-index: -1;
    }
    
    @keyframes rainfall {
      to {
        transform: translateY(105vh);
      }
    }
    
    /* 3D Canvas */
    #weather3d {
      width: 100%;
      height: 200px;
      border-radius: 1rem;
      margin-top: 1rem;
    }
    
    /* News cards */
    .news-card {
      transition: all 0.3s ease;
      border-left: 3px solid var(--primary-color);
    }
    .news-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    /* Health recommendations */
    .health-item {
      transition: all 0.3s ease;
      padding: 0.5rem;
      border-radius: 0.5rem;
    }
    .health-item:hover {
      background: linear-gradient(90deg, rgba(71,169,235,0.1), transparent);
      transform: translateX(5px);
    }
    
    /* Custom toggle switch */
    .toggle-checkbox:checked {
      right: 0;
      border-color: var(--primary-color);
    }
    .toggle-checkbox:checked + .toggle-label {
      background: var(--primary-color);
    }
  </style>
</head>
<body class="bg-[var(--background-color)] text-[var(--text-primary)]">

  <div class="min-h-screen flex flex-col">
    <header class="flex items-center justify-between gap-4 border-b border-[var(--border-color)] px-6 py-4 sticky top-0 bg-[var(--background-color)] z-10 backdrop-blur-md">
      <div class="flex items-center gap-3">
        <div class="relative">
          <svg class="h-8 w-8 text-[var(--primary-color)] spin-slow" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
          </svg>
        </div>
        <h1 class="text-2xl font-bold tracking-tight">WeatherWise</h1>
        <p class="text-sm text-[var(--text-secondary)] hidden sm:block">Live local weather, fast.</p>
      </div>

      <form id="searchForm" class="flex items-center gap-2 flex-1 max-w-xl justify-end" aria-label="Search weather by city">
        <label for="cityInput" class="sr-only">City</label>
        
        <div class="search-group">
            <div class="anim-layer anim-layer-1"></div>
            <div class="anim-layer anim-layer-2"></div>
            <div class="anim-layer anim-layer-3"></div>
            <div class="anim-layer anim-layer-4"></div>
            <div class="anim-layer anim-layer-5"></div>
            <div class="anim-layer anim-layer-6"></div>

            <div id="animated-search-box">
                <input id="cityInput" name="city" type="search" placeholder="Search city..." class="animated" />
                <div id="search-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" height="24" fill="none" class="feather feather-search">
                        <circle stroke="url(#search)" r="8" cy="11" cx="11"></circle>
                        <line stroke="url(#searchl)" y2="16.65" y1="22" x2="16.65" x1="22"></line>
                        <defs>
                            <linearGradient gradientTransform="rotate(50)" id="search">
                                <stop stop-color="#f8e7f8" offset="0%"></stop>
                                <stop stop-color="#b6a9b7" offset="50%"></stop>
                            </linearGradient>
                            <linearGradient id="searchl">
                                <stop stop-color="#b6a9b7" offset="0%"></stop>
                                <stop stop-color="#837484" offset="50%"></stop>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
            </div>
        </div>
        <button id="searchBtn" type="submit" class="inline-flex items-center gap-2 rounded-full bg-gradient-to-r from-[var(--primary-color)] to-[var(--secondary-color)] px-4 py-2 text-sm font-semibold text-white shadow hover:brightness-110 focus:outline-none transition-all duration-300 transform hover:scale-105" aria-label="Search">
          <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10.5 18a7.5 7.5 0 100-15 7.5 7.5 0 000 15z"></path></svg>
          Search
        </button>
        <button id="clearBtn" type="button" class="hidden md:inline-flex items-center gap-2 rounded-full bg-[var(--card-background)] px-3 py-2 text-sm text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300" aria-label="Clear search">Clear</button>
        <button id="themeToggle" type="button" class="ml-2 rounded-full p-2 bg-[var(--card-background)] hover:bg-[var(--primary-color)] hover:bg-opacity-20 transition-colors duration-300" aria-label="Toggle theme">
          <svg id="themeIcon" class="h-5 w-5 text-[var(--text-secondary)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1M4.2 4.2l.7.7M18.1 18.1l.7.7M1 12h1m20 0h1M4.2 19.8l.7-.7M18.1 5.9l.7-.7M12 5a7 7 0 100 14 7 7 0 000-14z"></path></svg>
        </button>
      </form>
    </header>

    <main class="flex-1 flex items-start justify-center px-4 py-8 sm:px-6 lg:px-8">
      <div class="w-full max-w-7xl grid grid-cols-1 gap-6 md:grid-cols-3">

        <section class="card md:col-span-2 fade-in relative overflow-hidden" aria-labelledby="cityName">
          <div id="weatherBackground" class="weather-bg"></div>
          <div class="flex items-start justify-between relative z-10">
            <div>
              <h2 id="cityName" class="text-4xl font-bold">Sunnyvale</h2>
              <p id="dateTime" class="text-[var(--text-secondary)]">Monday, 10:00 AM</p>
              <p id="localTime" class="text-sm text-[var(--text-secondary)] mt-1"></p>
            </div>
            <div class="flex items-center gap-4">
              <img id="weatherIcon" class="h-20 w-20 transition-transform duration-500 hover:rotate-12 float-animation" src="https://openweathermap.org/img/wn/01d@2x.png" alt="Weather Icon" />
            </div>
          </div>

          <div class="mt-6 flex items-end justify-between relative z-10">
            <p id="temp" class="text-6xl font-bold">25¬∞C</p>
            <div class="text-right">
              <p id="condition" class="font-medium">Clear Sky</p>
              <p id="feelsLike" class="text-sm text-[var(--text-secondary)]">Feels like 27¬∞C</p>
              <p id="highLow" class="text-sm text-[var(--text-secondary)]">H: 28¬∞ L: 22¬∞</p>
            </div>
          </div>

          <div id="weather3d" class="mt-4"></div>

          <div id="errorMsg" class="mt-4 hidden rounded-md border border-red-400 bg-red-50 px-4 py-2 text-sm text-red-700" role="alert"></div>
          <div id="loading" class="mt-4 hidden flex items-center gap-2 text-[var(--text-secondary)]">
            <svg class="h-5 w-5 animate-spin" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>
            Fetching weather...
          </div>
        </section>

        <aside class="card fade-in space-y-4 scroll-fade-in" aria-labelledby="detailsHeading">
          <h3 id="detailsHeading" class="text-lg font-bold">Current Details</h3>
          <div class="space-y-3">
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4 4 0 003 15z"></path></svg>
                <p>Humidity</p>
              </div>
              <p id="humidity" class="font-medium">60%</p>
            </div>
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <p>Wind</p>
              </div>
              <p id="wind" class="font-medium">15 km/h</p>
            </div>
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
                <p>Pressure</p>
              </div>
              <p id="pressure" class="font-medium">1012 hPa</p>
            </div>
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                <p>Visibility</p>
              </div>
              <p id="visibility" class="font-medium">10 km</p>
            </div>
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m-8-8h1m16 0h1M5.6 5.6l.7.7m11.1-.7l-.7.7"></path></svg>
                <p>UV Index</p>
              </div>
              <p id="uvIndex" class="font-medium">5</p>
            </div>
            <div class="flex justify-between text-[var(--text-secondary)] hover:text-[var(--text-primary)] transition-colors duration-300">
              <div class="flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p>Sunrise/Sunset</p>
              </div>
              <div>
                <p id="sunrise" class="font-medium text-right">6:20 AM</p>
                <p id="sunset" class="font-medium text-right">7:45 PM</p>
              </div>
            </div>
          </div>
        </aside>

        <section class="card md:col-span-3 fade-in scroll-fade-in relative" aria-labelledby="mapHeading">
          <h3 id="mapHeading" class="text-lg font-bold mb-4">Interactive Weather Map</h3>
          <div class="map-toggle">
            <button id="mapTempBtn" class="map-toggle-btn active">Temperature</button>
            <button id="mapPrecipBtn" class="map-toggle-btn">Precipitation</button>
            <button id="mapWindBtn" class="map-toggle-btn">Wind</button>
            <button id="mapPressureBtn" class="map-toggle-btn">Pressure</button>
          </div>
          <div id="map"></div>
          <p class="text-sm text-[var(--text-secondary)] mt-2">Click on any location to get weather data</p>
        </section>

        <section class="card md:col-span-2 fade-in scroll-fade-in" aria-labelledby="newsHeading">
          <h3 id="newsHeading" class="text-lg font-bold mb-4">Weather News & Alerts</h3>
          <div id="newsContainer" class="space-y-3 max-h-96 overflow-y-auto pr-2">
            <div class="news-card p-3 rounded-lg bg-opacity-10 bg-[var(--primary-color)]">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-medium">Heatwave Advisory for Northern California</h4>
                  <p class="text-sm text-[var(--text-secondary)] mt-1">Temperatures expected to reach 40¬∞C this weekend. Stay hydrated and avoid prolonged sun exposure.</p>
                </div>
                <span class="ml-2 flex-shrink-0 px-2 py-1 bg-red-500 text-white text-xs rounded-full">Alert</span>
              </div>
              <p class="text-xs text-[var(--text-secondary)] mt-2">2 hours ago ¬∑ Weather Authority</p>
            </div>
            <div class="news-card p-3 rounded-lg bg-opacity-10 bg-[var(--primary-color)]">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-medium">Winter Storm Warning: Sierra Nevada</h4>
                  <p class="text-sm text-[var(--text-secondary)] mt-1">Heavy snowfall expected above 5000 feet. Travel restrictions may apply.</p>
                </div>
                <span class="ml-2 flex-shrink-0 px-2 py-1 bg-orange-500 text-white text-xs rounded-full">Warning</span>
              </div>
              <p class="text-xs text-[var(--text-secondary)] mt-2">5 hours ago ¬∑ National Weather Service</p>
            </div>
            <div class="news-card p-3 rounded-lg bg-opacity-10 bg-[var(--primary-color)]">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <h4 class="font-medium">Best Places to Experience Fall Foliage</h4>
                  <p class="text-sm text-[var(--text-secondary)] mt-1">New England forests are showing spectacular colors this season due to ideal weather conditions.</p>
                </div>
              </div>
              <p class="text-xs text-[var(--text-secondary)] mt-2">1 day ago ¬∑ Travel & Leisure</p>
            </div>
          </div>
          <button id="loadMoreNews" class="w-full mt-4 rounded-lg bg-[var(--card-background)] py-2 text-sm font-medium text-[var(--text-primary)] hover:bg-[var(--primary-color)] hover:bg-opacity-20 transition-colors">Load More News</button>
        </section>

        <section class="card fade-in scroll-fade-in" aria-labelledby="healthHeading">
          <h3 id="healthHeading" class="text-lg font-bold mb-4">Health Recommendations</h3>
          <div class="space-y-3">
            <div class="health-item">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-[var(--success-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p class="font-medium">Air Quality</p>
              </div>
              <p class="text-sm text-[var(--text-secondary)] mt-1">Good for outdoor activities</p>
            </div>
            <div class="health-item">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p class="font-medium">UV Exposure</p>
              </div>
              <p class="text-sm text-[var(--text-secondary)] mt-1">Moderate - sunscreen recommended</p>
            </div>
            <div class="health-item">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-[var(--success-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p class="font-medium">Allergy Risk</p>
              </div>
              <p class="text-sm text-[var(--text-secondary)] mt-1">Low pollen count</p>
            </div>
            <div class="health-item">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-[var(--success-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                <p class="font-medium">Hydration</p>
              </div>
              <p class="text-sm text-[var(--text-secondary)] mt-1">Normal fluid intake recommended</p>
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-[var(--border-color)]">
            <h4 class="font-medium mb-2">Activity Safety</h4>
            <div class="flex items-center gap-2 text-sm text-[var(--text-secondary)]">
              <svg class="h-4 w-4 text-[var(--success-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
              <p>All outdoor activities are generally safe</p>
            </div>
          </div>
        </section>

        <section class="card md:col-span-3 fade-in scroll-fade-in" aria-labelledby="plannerHeading">
          <h3 id="plannerHeading" class="text-lg font-bold mb-4">Weather Planner</h3>
          <p class="text-sm text-[var(--text-secondary)] mb-4">Plan activities based on weather conditions</p>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-medium mb-3">Suggested Activities</h4>
              <div id="activitySuggestions" class="grid grid-cols-2 gap-3">
                <div class="activity-suggestion p-3 rounded-lg bg-opacity-20 bg-[var(--primary-color)] text-center cursor-pointer" data-activity="Beach Day">
                  <div class="text-2xl mb-1">üèñÔ∏è</div>
                  <p class="text-sm font-medium">Beach Day</p>
                </div>
                <div class="activity-suggestion p-3 rounded-lg bg-opacity-20 bg-[var(--primary-color)] text-center cursor-pointer" data-activity="Hiking">
                  <div class="text-2xl mb-1">ü•æ</div>
                  <p class="text-sm font-medium">Hiking</p>
                </div>
                <div class="activity-suggestion p-3 rounded-lg bg-opacity-20 bg-[var(--primary-color)] text-center cursor-pointer" data-activity="Picnic">
                  <div class="text-2xl mb-1">üß∫</div>
                  <p class="text-sm font-medium">Picnic</p>
                </div>
                <div class="activity-suggestion p-3 rounded-lg bg-opacity-20 bg-[var(--primary-color)] text-center cursor-pointer" data-activity="City Tour">
                  <div class="text-2xl mb-1">üèõÔ∏è</div>
                  <p class="text-sm font-medium">City Tour</p>
                </div>
              </div>
            </div>
            
            <div>
              <h4 class="font-medium mb-3">Add New Plan</h4>
              <form id="plannerForm" class="space-y-3">
                <div>
                  <label for="planDate" class="block text-sm font-medium mb-1">Date</label>
                  <input type="date" id="planDate" class="w-full rounded-lg border border-[var(--border-color)] bg-[var(--card-background)] px-3 py-2 text-sm" required>
                </div>
                <div>
                  <label for="planActivity" class="block text-sm font-medium mb-1">Activity</label>
                  <input type="text" id="planActivity" class="w-full rounded-lg border border-[var(--border-color)] bg-[var(--card-background)] px-3 py-2 text-sm" placeholder="Enter activity" required>
                </div>
                <div>
                  <label for="planTime" class="block text-sm font-medium mb-1">Time</label>
                  <input type="time" id="planTime" class="w-full rounded-lg border border-[var(--border-color)] bg-[var(--card-background)] px-3 py-2 text-sm" required>
                </div>
                <button type="submit" class="w-full rounded-lg bg-gradient-to-r from-[var(--primary-color)] to-[var(--secondary-color)] py-2 text-sm font-medium text-white">Add to Planner</button>
              </form>
            </div>
          </div>
          
          <div class="mt-6">
            <h4 class="font-medium mb-3">Your Plans</h4>
            <div id="plansList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
              <div class="planner-item weather-appropriate p-3 rounded-lg bg-opacity-10 bg-[var(--success-color)] flex justify-between items-center">
                <div>
                  <p class="font-medium">Beach Day</p>
                  <p class="text-sm text-[var(--text-secondary)]">Today, 2:00 PM</p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs px-2 py-1 rounded-full bg-[var(--success-color)] bg-opacity-20">Ideal Weather</span>
                  <button class="text-red-500 hover:text-red-700">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                  </button>
                </div>
              </div>
              <div class="planner-item weather-caution p-3 rounded-lg bg-opacity-10 bg-[var(--accent-color)] flex justify-between items-center">
                <div>
                  <p class="font-medium">Hiking</p>
                  <p class="text-sm text-[var(--text-secondary)]">Tomorrow, 10:00 AM</p>
                </div>
                <div class="flex items-center gap-2">
                  <span class="text-xs px-2 py-1 rounded-full bg-[var(--accent-color)] bg-opacity-20">Moderate</span>
                  <button class="text-red-500 hover:text-red-700">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section class="card md:col-span-3 fade-in scroll-fade-in" aria-labelledby="forecastHeading">
          <h3 id="forecastHeading" class="text-lg font-bold mb-4">5-Day Forecast</h3>
          <div id="forecastContainer" class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div class="forecast-card p-3 rounded-lg bg-opacity-50 bg-[var(--primary-color)] text-center">
              <p class="font-medium">Tue</p>
              <img src="https://openweathermap.org/img/wn/02d@2x.png" alt="Few clouds" class="h-12 w-12 mx-auto">
              <p class="text-lg font-semibold">26¬∞C</p>
              <p class="text-sm text-[var(--text-secondary)]">Few clouds</p>
            </div>
            <div class="forecast-card p-3 rounded-lg bg-opacity-50 bg-[var(--primary-color)] text-center">
              <p class="font-medium">Wed</p>
              <img src="https://openweathermap.org/img/wn/03d@2x.png" alt="Scattered clouds" class="h-12 w-12 mx-auto">
              <p class="text-lg font-semibold">24¬∞C</p>
              <p class="text-sm text-[var(--text-secondary)]">Cloudy</p>
            </div>
            <div class="forecast-card p-3 rounded-lg bg-opacity-50 bg-[var(--primary-color)] text-center">
              <p class="font-medium">Thu</p>
              <img src="https://openweathermap.org/img/wn/10d@2x.png" alt="Rain" class="h-12 w-12 mx-auto">
              <p class="text-lg font-semibold">21¬∞C</p>
              <p class="text-sm text-[var(--text-secondary)]">Rain</p>
            </div>
            <div class="forecast-card p-3 rounded-lg bg-opacity-50 bg-[var(--primary-color)] text-center">
              <p class="font-medium">Fri</p>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-12 w-12 mx-auto">
              <p class="text-lg font-semibold">27¬∞C</p>
              <p class="text-sm text-[var(--text-secondary)]">Sunny</p>
            </div>
            <div class="forecast-card p-3 rounded-lg bg-opacity-50 bg-[var(--primary-color)] text-center">
              <p class="font-medium">Sat</p>
              <img src="https://openweathermap.org/img/wn/02d@2x.png" alt="Few clouds" class="h-12 w-12 mx-auto">
              <p class="text-lg font-semibold">25¬∞C</p>
              <p class="text-sm text-[var(--text-secondary)]">Partly cloudy</p>
            </div>
          </div>
        </section>

        <section class="card md:col-span-2 fade-in scroll-fade-in" aria-labelledby="aqiHeading">
          <h3 id="aqiHeading" class="text-lg font-bold mb-4">Air Quality Index</h3>
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="h-3 bg-gradient-to-r from-green-400 via-yellow-400 to-red-500 rounded-full mb-2"></div>
              <div class="flex justify-between text-xs text-[var(--text-secondary)]">
                <span>Good</span>
                <span>Moderate</span>
                <span>Unhealthy</span>
              </div>
            </div>
            <div class="ml-4 text-center">
              <p id="aqiValue" class="text-3xl font-bold text-[var(--success-color)]">42</p>
              <p class="text-sm text-[var(--text-secondary)]">Good</p>
            </div>
          </div>
          <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div class="flex justify-between">
              <p class="text-[var(--text-secondary)]">PM2.5</p>
              <p id="pm25" class="font-medium">12 Œºg/m¬≥</p>
            </div>
            <div class="flex justify-between">
              <p class="text-[var(--text-secondary)]">PM10</p>
              <p id="pm10" class="font-medium">24 Œºg/m¬≥</p>
            </div>
            <div class="flex justify-between">
              <p class="text-[var(--text-secondary)]">O‚ÇÉ</p>
              <p id="o3" class="font-medium">68 Œºg/m¬≥</p>
            </div>
            <div class="flex justify-between">
              <p class="text-[var(--text-secondary)]">NO‚ÇÇ</p>
              <p id="no2" class="font-medium">18 Œºg/m¬≥</p>
            </div>
          </div>
        </section>

        <section class="card fade-in scroll-fade-in" aria-labelledby="hourlyHeading">
          <h3 id="hourlyHeading" class="text-lg font-bold mb-4">Today's Forecast</h3>
          <div class="space-y-3 max-h-80 overflow-y-auto pr-2">
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">Now</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">25¬∞C</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">1 PM</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">26¬∞C</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">2 PM</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">27¬∞C</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">3 PM</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">28¬∞C</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">4 PM</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">27¬∞C</span>
            </div>
            <div class="flex justify-between items-center py-2 border-b border-[var(--border-color)] hover:bg-[var(--primary-color)] hover:bg-opacity-10 hover:rounded-lg px-2 transition-all duration-300">
              <span class="font-medium">5 PM</span>
              <img src="https://openweathermap.org/img/wn/01d@2x.png" alt="Clear" class="h-8 w-8">
              <span class="font-semibold">26¬∞C</span>
            </div>
          </div>
        </section>

      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

  <script>
    const apiKey = "4643b32587ada95a4b59a4d9e89c1c09";

    // Elements
    const cityInput = document.getElementById('cityInput');
    const searchForm = document.getElementById('searchForm');
    const searchBtn = document.getElementById('searchBtn');
    const clearBtn = document.getElementById('clearBtn');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');

    const cityNameElem = document.getElementById('cityName');
    const tempElem = document.getElementById('temp');
    const conditionElem = document.getElementById('condition');
    const feelsLikeElem = document.getElementById('feelsLike');
    const highLowElem = document.getElementById('highLow');
    const weatherIcon = document.getElementById('weatherIcon');
    const humidityElem = document.getElementById('humidity');
    const windElem = document.getElementById('wind');
    const pressureElem = document.getElementById('pressure');
    const visibilityElem = document.getElementById('visibility');
    const uvIndexElem = document.getElementById('uvIndex');
    const sunriseElem = document.getElementById('sunrise');
    const sunsetElem = document.getElementById('sunset');
    const dateTimeElem = document.getElementById('dateTime');
    const localTimeElem = document.getElementById('localTime');
    const loadingElem = document.getElementById('loading');
    const errorMsg = document.getElementById('errorMsg');
    const weatherBackground = document.getElementById('weatherBackground');
    const aqiValue = document.getElementById('aqiValue');
    const pm25 = document.getElementById('pm25');
    const pm10 = document.getElementById('pm10');
    const o3 = document.getElementById('o3');
    const no2 = document.getElementById('no2');

    // Map elements
    const mapTempBtn = document.getElementById('mapTempBtn');
    const mapPrecipBtn = document.getElementById('mapPrecipBtn');
    const mapWindBtn = document.getElementById('mapWindBtn');
    const mapPressureBtn = document.getElementById('mapPressureBtn');

    // Planner elements
    const plannerForm = document.getElementById('plannerForm');
    const planDate = document.getElementById('planDate');
    const planActivity = document.getElementById('planActivity');
    const planTime = document.getElementById('planTime');
    const plansList = document.getElementById('plansList');
    const activitySuggestions = document.getElementById('activitySuggestions');

    // News elements
    const newsContainer = document.getElementById('newsContainer');
    const loadMoreNews = document.getElementById('loadMoreNews');

    // 3D elements
    const weather3d = document.getElementById('weather3d');

    // Map variables
    let map = null;
    let currentMarker = null;
    let mapLayerType = 'temperature';

    // Planner variables
    let userPlans = JSON.parse(localStorage.getItem('weatherwisePlans')) || [];
    let currentWeatherData = null;
    let forecastData = null;

    // Three.js variables
    let scene, camera, renderer, weatherObject;

    // Timezone and local time variables
    let currentTimezoneOffset = 0;
    let localTimeInterval;

    // Weather effects
    let currentWeatherEffects = [];

    // Initialize Three.js
    function init3DWeather() {
      // Set up scene
      scene = new THREE.Scene();
      
      // Set up camera
      camera = new THREE.PerspectiveCamera(75, weather3d.clientWidth / weather3d.clientHeight, 0.1, 1000);
      camera.position.z = 5;
      
      // Set up renderer
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(weather3d.clientWidth, weather3d.clientHeight);
      weather3d.appendChild(renderer.domElement);
      
      // Add ambient light
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      
      // Add directional light
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);
      
      // Create initial weather object (sun)
      createWeatherObject('clear');
      
      // Start animation
      animate();
    }
    
    // Create 3D weather object based on condition
    function createWeatherObject(condition) {
      // Remove existing weather object
      if (weatherObject) {
        scene.remove(weatherObject);
      }
      
      const conditionLower = condition.toLowerCase();
      
      if (conditionLower.includes('clear')) {
        // Create sun
        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshPhongMaterial({ 
          color: 0xffd700,
          emissive: 0xffcc00,
          emissiveIntensity: 0.5
        });
        weatherObject = new THREE.Mesh(geometry, material);
        
        // Add glow effect
        const glowGeometry = new THREE.SphereGeometry(1.2, 32, 32);
        const glowMaterial = new THREE.MeshBasicMaterial({
          color: 0xffaa00,
          transparent: true,
          opacity: 0.3
        });
        const glow = new THREE.Mesh(glowGeometry, glowMaterial);
        weatherObject.add(glow);
        
      } else if (conditionLower.includes('cloud')) {
        // Create cloud group
        weatherObject = new THREE.Group();
        
        // Create several cloud puffs
        for (let i = 0; i < 5; i++) {
          const size = 0.4 + Math.random() * 0.3;
          const geometry = new THREE.SphereGeometry(size, 16, 16);
          const material = new THREE.MeshPhongMaterial({ 
            color: 0xffffff,
            transparent: true,
            opacity: 0.9
          });
          const cloudPuff = new THREE.Mesh(geometry, material);
          
          // Position cloud puffs
          cloudPuff.position.x = (Math.random() - 0.5) * 2;
          cloudPuff.position.y = (Math.random() - 0.5) * 1.5;
          cloudPuff.position.z = (Math.random() - 0.5) * 1;
          
          weatherObject.add(cloudPuff);
        }
        
      } else if (conditionLower.includes('rain') || conditionLower.includes('drizzle')) {
        // Create rain cloud
        weatherObject = new THREE.Group();
        
        // Create cloud base
        const cloudGeometry = new THREE.SphereGeometry(1, 16, 16);
        const cloudMaterial = new THREE.MeshPhongMaterial({ 
          color: 0x777777,
          transparent: true,
          opacity: 0.9
        });
        const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
        weatherObject.add(cloud);
        
        // Create rain drops
        for (let i = 0; i < 30; i++) {
          const geometry = new THREE.CylinderGeometry(0.02, 0.05, 0.3, 8);
          const material = new THREE.MeshPhongMaterial({ color: 0x5588cc });
          const raindrop = new THREE.Mesh(geometry, material);
          
          // Position raindrops
          raindrop.position.x = (Math.random() - 0.5) * 2;
          raindrop.position.y = -0.8 - Math.random() * 1.5;
          raindrop.position.z = (Math.random() - 0.5) * 0.5;
          
          weatherObject.add(raindrop);
        }
        
      } else if (conditionLower.includes('snow')) {
        // Create snow cloud
        weatherObject = new THREE.Group();
        
        // Create cloud base
        const cloudGeometry = new THREE.SphereGeometry(1, 16, 16);
        const cloudMaterial = new THREE.MeshPhongMaterial({ 
          color: 0xdddddd,
          transparent: true,
          opacity: 0.9
        });
        const cloud = new THREE.Mesh(cloudGeometry, cloudMaterial);
        weatherObject.add(cloud);
        
        // Create snowflakes
        for (let i = 0; i < 20; i++) {
          const geometry = new THREE.SphereGeometry(0.05, 8, 8);
          const material = new THREE.MeshPhongMaterial({ color: 0xffffff });
          const snowflake = new THREE.Mesh(geometry, material);
          
          // Position snowflakes
          snowflake.position.x = (Math.random() - 0.5) * 2;
          snowflake.position.y = -0.8 - Math.random() * 1.5;
          snowflake.position.z = (Math.random() - 0.5) * 0.5;
          
          weatherObject.add(snowflake);
        }
        
      } else {
        // Default: sun
        const geometry = new THREE.SphereGeometry(1, 32, 32);
        const material = new THREE.MeshPhongMaterial({ 
          color: 0xffd700,
          emissive: 0xffcc00,
          emissiveIntensity: 0.5
        });
        weatherObject = new THREE.Mesh(geometry, material);
      }
      
      scene.add(weatherObject);
    }
    
    // Animation loop for Three.js
    function animate() {
      requestAnimationFrame(animate);
      
      if (weatherObject) {
        // Rotate the weather object
        weatherObject.rotation.y += 0.01;
        
        // Special animations based on weather type
        const condition = currentWeatherData ? currentWeatherData.weather[0].main.toLowerCase() : 'clear';
        
        if (condition.includes('rain') || condition.includes('drizzle')) {
          // Animate raindrops
          weatherObject.children.forEach(child => {
            if (child.position.y < -2) {
              child.position.y = -0.8;
            } else {
              child.position.y -= 0.05;
            }
          });
        } else if (condition.includes('snow')) {
          // Animate snowflakes
          weatherObject.children.forEach(child => {
            if (child.position.y < -2) {
              child.position.y = -0.8;
              child.position.x = (Math.random() - 0.5) * 2;
            } else {
              child.position.y -= 0.02;
              child.position.x += (Math.random() - 0.5) * 0.02;
            }
          });
        }
      }
      
      renderer.render(scene, camera);
    }
    
    // Handle window resize
    function onWindowResize() {
      if (camera && renderer) {
        camera.aspect = weather3d.clientWidth / weather3d.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(weather3d.clientWidth, weather3d.clientHeight);
      }
    }

    // Initialize the map
    function initMap(lat = 37.3688, lng = -122.0363) {
      if (map === null) {
        map = L.map('map').setView([lat, lng], 10);
        
        // Add tile layer (map background)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // Add click event to map
        map.on('click', function(e) {
          getWeatherByCoords(e.latlng.lat, e.latlng.lng);
        });
      } else {
        map.setView([lat, lng], 10);
      }
      
      // Update map theme based on current theme
      updateMapTheme();
    }

    // Update map theme based on light/dark mode
    function updateMapTheme() {
      if (!map) return;
      
      // Remove existing tile layers
      map.eachLayer(layer => {
        if (layer instanceof L.TileLayer) {
          map.removeLayer(layer);
        }
      });
      
      // Add appropriate tile layer based on theme
      const isLight = document.documentElement.classList.contains('light');
      
      if (isLight) {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openweathermap.org/copyright">OpenWeatherMap</a> contributors'
        }).addTo(map);
      } else {
        // Use a dark map theme
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; <a href="https://www.openweathermap.org/copyright">OpenWeatherMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
          subdomains: 'abcd',
          maxZoom: 20
        }).addTo(map);
      }
    }

    // Add marker to map
    function addMapMarker(lat, lng, city, temp, condition) {
      // Remove existing marker if any
      if (currentMarker) {
        map.removeLayer(currentMarker);
      }
      
      // Create custom icon with temperature
      const customIcon = L.divIcon({
        className: 'weather-marker',
        html: `<div class="map-temp-label" style="color: ${getTemperatureColor(temp)}">${Math.round(temp)}¬∞C</div>`,
        iconSize: [40, 40],
        iconAnchor: [20, 40]
      });
      
      // Add marker to map
      currentMarker = L.marker([lat, lng], {icon: customIcon})
        .addTo(map)
        .bindPopup(`<b>${city}</b><br>${temp}¬∞C, ${condition}`)
        .openPopup();
    }

    // Get color based on temperature
    function getTemperatureColor(temp) {
      if (temp <= 0) return '#6366f1'; // blue for cold
      if (temp <= 10) return '#38bdf8'; // light blue for cool
      if (temp <= 20) return '#22c55e'; // green for mild
      if (temp <= 30) return '#eab308'; // yellow for warm
      return '#ef4444'; // red for hot
    }

    // Set weather-based background
    function setWeatherBackground(condition, temp, isDaytime) {
      // Clear any existing weather effects
      clearWeatherEffects();
      
      const root = document.documentElement;
      let bg1, bg2;
      
      // Convert condition to lowercase for easier matching
      const conditionLower = condition.toLowerCase();
      
      // Set background based on weather condition
      if (conditionLower.includes('clear')) {
        if (isDaytime) {
          // Sunny day
          bg1 = '#47B5FF'; // Light blue
          bg2 = '#FFC107'; // Warm yellow
        } else {
          // Clear night
          bg1 = '#0A1931'; // Dark blue
          bg2 = '#1E2A4A'; // Slightly lighter blue
        }
      } else if (conditionLower.includes('cloud')) {
        if (isDaytime) {
          // Cloudy day
          bg1 = '#78909C'; // Gray blue
          bg2 = '#B0BEC5'; // Light gray
        } else {
          // Cloudy night
          bg1 = '#263238'; // Dark gray
          bg2 = '#37474F'; // Medium gray
        }
      } else if (conditionLower.includes('rain') || conditionLower.includes('drizzle')) {
        // Rainy weather
        bg1 = '#0D47A1'; // Deep blue
        bg2 = '#546E7A'; // Gray blue
        createRainEffect();
      } else if (conditionLower.includes('thunderstorm')) {
        // Stormy weather
        bg1 = '#311B92'; // Deep purple
        bg2 = '#000000'; // Black
        createThunderEffect();
      } else if (conditionLower.includes('snow')) {
        // Snowy weather
        bg1 = '#E3F2FD'; // Light blue
        bg2 = '#90CAF9'; // Soft blue
        createSnowEffect();
      } else if (conditionLower.includes('mist') || conditionLower.includes('fog') || conditionLower.includes('haze')) {
        // Foggy weather
        bg1 = '#9E9E9E'; // Medium gray
        bg2 = '#BDBDBD'; // Light gray
      } else {
        // Default background based on time of day
        if (isDaytime) {
          bg1 = '#0f172a'; // Default dark
          bg2 = '#1e293b'; // Default darker
        } else {
          bg1 = '#0A1931'; // Dark blue
          bg2 = '#1E2A4A'; // Slightly lighter blue
        }
      }
      
      // Adjust for temperature (warmer colors for higher temps)
      if (temp > 30) {
        // Very hot - add red tones
        bg1 = adjustColorTemperature(bg1, 0.2);
        bg2 = adjustColorTemperature(bg2, 0.1);
      } else if (temp > 20) {
        // Warm - add yellow tones
        bg1 = adjustColorTemperature(bg1, 0.1);
      } else if (temp < 0) {
        // Very cold - add blue tones
        bg1 = adjustColorTemperature(bg1, -0.2);
        bg2 = adjustColorTemperature(bg2, -0.1);
      } else if (temp < 10) {
        // Cold - add blue tones
        bg1 = adjustColorTemperature(bg1, -0.1);
      }
      
      // Set the CSS variables
      root.style.setProperty('--weather-bg-1', bg1);
      root.style.setProperty('--weather-bg-2', bg2);
    }
    
    // Helper function to adjust color temperature
    function adjustColorTemperature(color, factor) {
      // Simple implementation - in a real app you'd use a more sophisticated method
      if (factor > 0) {
        // Make warmer (add red/yellow)
        return color; // Simplified for this example
      } else {
        // Make cooler (add blue)
        return color; // Simplified for this example
      }
    }
    
    // Create rain effect
    function createRainEffect() {
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          const raindrop = document.createElement('div');
          raindrop.className = 'raindrop';
          raindrop.style.left = Math.random() * 100 + 'vw';
          raindrop.style.top = '-25px';
          raindrop.style.opacity = Math.random() * 0.5 + 0.3;
          raindrop.style.animationDuration = (Math.random() * 0.5 + 0.5) + 's';
          document.body.appendChild(raindrop);
          
          currentWeatherEffects.push(raindrop);
          
          // Remove raindrop after animation completes
          setTimeout(() => {
            if (raindrop.parentNode) {
              raindrop.parentNode.removeChild(raindrop);
            }
          }, 2000);
        }, i * 100);
      }
    }
    
    // Create snow effect
    function createSnowEffect() {
      for (let i = 0; i < 75; i++) {
        setTimeout(() => {
          const snowflake = document.createElement('div');
          snowflake.className = 'snowflake';
          snowflake.innerHTML = '‚ùÑ';
          snowflake.style.left = Math.random() * 100 + 'vw';
          snowflake.style.fontSize = (Math.random() * 10 + 10) + 'px';
          snowflake.style.opacity = Math.random() * 0.7 + 0.3;
          snowflake.style.animationDuration = (Math.random() * 5 + 5) + 's';
          snowflake.style.animationDelay = Math.random() * 5 + 's';
          document.body.appendChild(snowflake);
          
          currentWeatherEffects.push(snowflake);
        }, i * 200);
      }
    }
    
    // Create thunder effect (lightning flashes)
    function createThunderEffect() {
      let flashCount = 0;
      const maxFlashes = 3 + Math.floor(Math.random() * 3);
      
      function flash() {
        if (flashCount >= maxFlashes) return;
        
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'white';
        overlay.style.opacity = '0.7';
        overlay.style.zIndex = '9999';
        overlay.style.pointerEvents = 'none';
        document.body.appendChild(overlay);
        
        currentWeatherEffects.push(overlay);
        
        setTimeout(() => {
          if (overlay.parentNode) {
            overlay.parentNode.removeChild(overlay);
          }
        }, 100);
        
        flashCount++;
        
        // Schedule next flash
        if (flashCount < maxFlashes) {
          setTimeout(flash, 500 + Math.random() * 2000);
        }
      }
      
      // Start the first flash after a random delay
      setTimeout(flash, 1000 + Math.random() * 2000);
    }
    
    // Clear all weather effects
    function clearWeatherEffects() {
      currentWeatherEffects.forEach(effect => {
        if (effect.parentNode) {
          effect.parentNode.removeChild(effect);
        }
      });
      currentWeatherEffects = [];
    }

    // Fetch weather news
    async function fetchWeatherNews() {
      try {
        // In a real implementation, you would use a news API
        // This is a simulated response
        const mockNews = [
          {
            title: "Heatwave Advisory for Northern California",
            description: "Temperatures expected to reach 40¬∞C this weekend. Stay hydrated and avoid prolonged sun exposure.",
            source: "Weather Authority",
            time: "2 hours ago",
            alert: true
          },
          {
            title: "Winter Storm Warning: Sierra Nevada",
            description: "Heavy snowfall expected above 5000 feet. Travel restrictions may apply.",
            source: "National Weather Service",
            time: "5 hours ago",
            warning: true
          },
          {
            title: "Best Places to Experience Fall Foliage",
            description: "New England forests are showing spectacular colors this season due to ideal weather conditions.",
            source: "Travel & Leisure",
            time: "1 day ago"
          }
        ];
        
        return mockNews;
      } catch (error) {
        console.error("Error fetching weather news:", error);
        return [];
      }
    }
    
    // Display weather news
    function displayWeatherNews(news) {
      newsContainer.innerHTML = '';
      
      news.forEach(item => {
        const newsElement = document.createElement('div');
        newsElement.className = 'news-card p-3 rounded-lg bg-opacity-10 bg-[var(--primary-color)]';
        
        let badge = '';
        if (item.alert) {
          badge = '<span class="ml-2 flex-shrink-0 px-2 py-1 bg-red-500 text-white text-xs rounded-full">Alert</span>';
        } else if (item.warning) {
          badge = '<span class="ml-2 flex-shrink-0 px-2 py-1 bg-orange-500 text-white text-xs rounded-full">Warning</span>';
        }
        
        newsElement.innerHTML = `
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <h4 class="font-medium">${item.title}</h4>
              <p class="text-sm text-[var(--text-secondary)] mt-1">${item.description}</p>
            </div>
            ${badge}
          </div>
          <p class="text-xs text-[var(--text-secondary)] mt-2">${item.time} ¬∑ ${item.source}</p>
        `;
        
        newsContainer.appendChild(newsElement);
      });
    }

    // Planner Functions
    function savePlans() {
      localStorage.setItem('weatherwisePlans', JSON.stringify(userPlans));
    }

    function renderPlans() {
      plansList.innerHTML = '';
      
      if (userPlans.length === 0) {
        plansList.innerHTML = '<p class="text-center text-[var(--text-secondary)] py-4">No plans yet. Add some activities to your planner!</p>';
        return;
      }
      
      userPlans.forEach((plan, index) => {
        const planElement = document.createElement('div');
        const weatherSuitability = assessWeatherSuitability(plan);
        
        planElement.className = `planner-item ${weatherSuitability.class} p-3 rounded-lg bg-opacity-10 flex justify-between items-center`;
        planElement.innerHTML = `
          <div>
            <p class="font-medium">${plan.activity}</p>
            <p class="text-sm text-[var(--text-secondary)]">${formatPlanDate(plan.date)}, ${plan.time}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs px-2 py-1 rounded-full ${weatherSuitability.bgClass}">${weatherSuitability.text}</span>
            <button class="text-red-500 hover:text-red-700 delete-plan" data-index="${index}">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </div>
        `;
        
        plansList.appendChild(planElement);
      });
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-plan').forEach(button => {
        button.addEventListener('click', function() {
          const index = parseInt(this.getAttribute('data-index'));
          userPlans.splice(index, 1);
          savePlans();
          renderPlans();
        });
      });
    }

    function assessWeatherSuitability(plan) {
      if (!currentWeatherData || !forecastData) {
        return { class: '', text: 'Unknown', bgClass: 'bg-gray-500 bg-opacity-20' };
      }
      
      // Simple implementation - in a real app you would compare plan date with forecast
      const temp = currentWeatherData.main.temp;
      const condition = currentWeatherData.weather[0].main.toLowerCase();
      
      // Beach day assessment
      if (plan.activity.toLowerCase().includes('beach')) {
        if (temp >= 25 && (condition.includes('clear') || condition.includes('cloud'))) {
          return { class: 'weather-appropriate', text: 'Ideal Weather', bgClass: 'bg-[var(--success-color)] bg-opacity-20' };
        } else if (temp >= 20 && condition.includes('cloud')) {
          return { class: 'weather-caution', text: 'Moderate', bgClass: 'bg-[var(--accent-color)] bg-opacity-20' };
        } else {
          return { class: 'weather-inappropriate', text: 'Not Ideal', bgClass: 'bg-red-500 bg-opacity-20' };
        }
      }
      
      // Hiking assessment
      if (plan.activity.toLowerCase().includes('hiking')) {
        if (temp >= 15 && temp <= 25 && !condition.includes('rain')) {
          return { class: 'weather-appropriate', text: 'Ideal Weather', bgClass: 'bg-[var(--success-color)] bg-opacity-20' };
        } else if (temp >= 10 && temp <= 30 && !condition.includes('rain')) {
          return { class: 'weather-caution', text: 'Moderate', bgClass: 'bg-[var(--accent-color)] bg-opacity-20' };
        } else {
          return { class: 'weather-inappropriate', text: 'Not Ideal', bgClass: 'bg-red-500 bg-opacity-20' };
        }
      }
      
      // Default assessment based on temperature and conditions
      if (temp >= 18 && temp <= 27 && !condition.includes('rain')) {
        return { class: 'weather-appropriate', text: 'Ideal Weather', bgClass: 'bg-[var(--success-color)] bg-opacity-20' };
      } else if (temp >= 10 && temp <= 32 && !condition.includes('rain')) {
        return { class: 'weather-caution', text: 'Moderate', bgClass: 'bg-[var(--accent-color)] bg-opacity-20' };
      } else {
        return { class: 'weather-inappropriate', text: 'Not Ideal', bgClass: 'bg-red-500 bg-opacity-20' };
      }
    }

    function formatPlanDate(dateString) {
      const options = { weekday: 'short', month: 'short', day: 'numeric' };
      const date = new Date(dateString);
      return date.toLocaleDateString(undefined, options);
    }

    function updateActivitySuggestions() {
      if (!currentWeatherData) return;
      
      const temp = currentWeatherData.main.temp;
      const condition = currentWeatherData.weather[0].main.toLowerCase();
      
      // Clear previous suggestions
      activitySuggestions.innerHTML = '';
      
      // Define activities based on weather
      const activities = [];
      
      if (temp >= 20 && (condition.includes('clear') || condition.includes('cloud'))) {
        activities.push({ name: 'Beach Day', emoji: 'üèñÔ∏è' });
      }
      
      if (temp >= 15 && temp <= 28 && !condition.includes('rain')) {
        activities.push({ name: 'Hiking', emoji: 'ü•æ' });
        activities.push({ name: 'Picnic', emoji: 'üß∫' });
      }
      
      if (temp >= 10 && temp <= 30 && !condition.includes('rain')) {
        activities.push({ name: 'City Tour', emoji: 'üèõÔ∏è' });
      }
      
      if (temp < 15 || condition.includes('rain')) {
        activities.push({ name: 'Museum Visit', emoji: 'üèõÔ∏è' });
        activities.push({ name: 'Coffee Shop', emoji: '‚òï' });
      }
      
      if (condition.includes('rain')) {
        activities.push({ name: 'Movie Day', emoji: 'üé¨' });
        activities.push({ name: 'Shopping', emoji: 'üõçÔ∏è' });
      }
      
      // Add default activities if we don't have enough
      if (activities.length < 4) {
        activities.push({ name: 'Reading', emoji: 'üìö' });
        activities.push({ name: 'Cooking', emoji: 'üë®‚Äçüç≥' });
      }
      
      // Render suggestions
      activities.slice(0, 4).forEach(activity => {
        const activityElement = document.createElement('div');
        activityElement.className = 'activity-suggestion p-3 rounded-lg bg-opacity-20 bg-[var(--primary-color)] text-center cursor-pointer';
        activityElement.setAttribute('data-activity', activity.name);
        activityElement.innerHTML = `
          <div class="text-2xl mb-1">${activity.emoji}</div>
          <p class="text-sm font-medium">${activity.name}</p>
        `;
        
        activityElement.addEventListener('click', () => {
          planActivity.value = activity.name;
          planDate.focus();
        });
        
        activitySuggestions.appendChild(activityElement);
      });
    }

    function setLoading(isLoading) {
      loadingElem.classList.toggle('hidden', !isLoading);
      searchBtn.disabled = isLoading;
    }

    function showError(message) {
      errorMsg.textContent = message;
      errorMsg.classList.remove('hidden');
      setTimeout(() => errorMsg.classList.add('hidden'), 5000);
    }

    function formatDateTime(timestamp, timezoneOffset) {
      const date = timestamp ? new Date(timestamp * 1000) : new Date();
      if (timezoneOffset) {
        const localTime = new Date(date.getTime() + timezoneOffset * 1000);
        return localTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function updateLocalTime() {
      if (!currentTimezoneOffset) return;
      
      const now = new Date();
      const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
      const localTime = new Date(utc + (1000 * currentTimezoneOffset));
      
      const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'UTC'
      };
      
      dateTimeElem.textContent = localTime.toLocaleDateString(undefined, options);
      localTimeElem.textContent = `Local Time: ${localTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
    }

    function setWeatherBackgroundEmoji(condition) {
      const conditionMap = {
        'clear': '‚òÄÔ∏è',
        'cloud': '‚òÅÔ∏è',
        'rain': 'üåßÔ∏è',
        'drizzle': 'üå¶Ô∏è',
        'thunderstorm': '‚õàÔ∏è',
        'snow': '‚ùÑÔ∏è',
        'mist': 'üå´Ô∏è',
        'smoke': 'üå´Ô∏è',
        'haze': 'üå´Ô∏è',
        'dust': 'üå´Ô∏è',
        'fog': 'üå´Ô∏è',
        'sand': 'üå´Ô∏è',
        'ash': 'üå´Ô∏è',
        'squall': 'üí®',
        'tornado': 'üå™Ô∏è'
      };

      const conditionLower = condition.toLowerCase();
      let bgEmoji = '‚òÄÔ∏è';

      for (const [key, emoji] of Object.entries(conditionMap)) {
        if (conditionLower.includes(key)) {
          bgEmoji = emoji;
          break;
        }
      }

      weatherBackground.style.backgroundImage = `url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' version='1.1' height='200px' width='200px'><text x='0' y='100' font-size='100' fill='rgba(255,255,255,0.05)'>${bgEmoji}</text></svg>")`;
    }

    function initScrollAnimations() {
      const scrollElements = document.querySelectorAll('.scroll-fade-in');
      
      const elementInView = (el, dividend = 1) => {
        const elementTop = el.getBoundingClientRect().top;
        return (
          elementTop <= (window.innerHeight || document.documentElement.clientHeight) / dividend
        );
      };
      
      const displayScrollElement = (element) => {
        element.classList.add('visible');
      };
      
      const handleScrollAnimation = () => {
        scrollElements.forEach((el) => {
          if (elementInView(el, 1.2)) {
            displayScrollElement(el);
          }
        });
      };
      
      window.addEventListener('scroll', () => {
        handleScrollAnimation();
      });
      
      // Initial check
      handleScrollAnimation();
    }

    async function getWeather(city) {
      if (!city || !city.trim()) {
        showError('Please enter a city name or ZIP code.');
        return;
      }

      setLoading(true);
      errorMsg.classList.add('hidden');

      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`);
        const data = await response.json();

        if (!response.ok) {
          showError(data.message || 'City not found');
          setLoading(false);
          return;
        }

        // Store current weather data for planner
        currentWeatherData = data;

        // Update map with new location
        initMap(data.coord.lat, data.coord.lon);
        addMapMarker(data.coord.lat, data.coord.lon, data.name, data.main.temp, data.weather[0].description);

        // Get air pollution data
        const pollutionResponse = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${data.coord.lat}&lon=${data.coord.lon}&appid=${apiKey}`);
        const pollutionData = await pollutionResponse.json();

        // Get 5-day forecast
        const forecastResponse = await fetch(`https://api.openweathermap.org/data/2.5/forecast?q=${encodeURIComponent(city)}&units=metric&appid=${apiKey}`);
        forecastData = await forecastResponse.json();

        // Update 3D weather visualization
        createWeatherObject(data.weather[0].main);

        // Fetch weather news
        const news = await fetchWeatherNews();
        displayWeatherNews(news);

        cityNameElem.textContent = data.name + (data.sys && data.sys.country ? (', ' + data.sys.country) : '');
        tempElem.textContent = Math.round(data.main.temp) + '¬∞C';
        conditionElem.textContent = data.weather[0].description.replace(/\b\w/g, c => c.toUpperCase());
        feelsLikeElem.textContent = 'Feels like ' + Math.round(data.main.feels_like) + '¬∞C';
        highLowElem.textContent = `H: ${Math.round(data.main.temp_max)}¬∞ L: ${Math.round(data.main.temp_min)}¬∞`;
        weatherIcon.src = `https://openweathermap.org/img/wn/${data.weather[0].icon}@2x.png`;
        humidityElem.textContent = data.main.humidity + '%';
        windElem.textContent = (data.wind.speed * 3.6).toFixed(1) + ' km/h'; // m/s -> km/h
        pressureElem.textContent = data.main.pressure + ' hPa';
        visibilityElem.textContent = (data.visibility / 1000).toFixed(1) + ' km';
        
        // Set UV index from pollution data if available
        if (pollutionData && pollutionData.list && pollutionData.list[0]) {
          uvIndexElem.textContent = pollutionData.list[0].main.aqi;
        }
        
        sunriseElem.textContent = formatDateTime(data.sys.sunrise, data.timezone);
        sunsetElem.textContent = formatDateTime(data.sys.sunset, data.timezone);
        
        // Set timezone and update time
        currentTimezoneOffset = data.timezone;
        clearInterval(localTimeInterval);
        updateLocalTime();
        localTimeInterval = setInterval(updateLocalTime, 60000); // Update every minute
        
        // Set weather background based on condition and time of day
        const isDaytime = data.weather[0].icon.includes('d');
        setWeatherBackground(data.weather[0].main, data.main.temp, isDaytime);
        setWeatherBackgroundEmoji(data.weather[0].main);
        
        // Update air quality data
        if (pollutionData && pollutionData.list && pollutionData.list[0]) {
          const aqi = pollutionData.list[0].main.aqi;
          aqiValue.textContent = aqi;
          // Set AQI color based on value
          if (aqi <= 1) aqiValue.style.color = 'var(--success-color)';
          else if (aqi <= 2) aqiValue.style.color = '#f59e0b';
          else if (aqi <= 4) aqiValue.style.color = '#ef4444';
          else aqiValue.style.color = '#dc2626';
          
          const components = pollutionData.list[0].components;
          pm25.textContent = components.pm2_5.toFixed(1) + ' Œºg/m¬≥';
          pm10.textContent = components.pm10.toFixed(1) + ' Œºg/m¬≥';
          o3.textContent = components.o3.toFixed(1) + ' Œºg/m¬≥';
          no2.textContent = components.no2.toFixed(1) + ' Œºg/m¬≥';
        }
        
        // Update activity suggestions based on current weather
        updateActivitySuggestions();
        
        // Re-render plans to update weather suitability
        renderPlans();

        document.querySelectorAll('.fade-in').forEach(el => el.classList.add('show'));
        
        // Trigger scroll animations
        setTimeout(initScrollAnimations, 100);
        
        // persist last successful city so we can reload it next time
        try { localStorage.setItem('weatherwiseLastCity', data.name); } catch (e) { /* ignore storage errors */ }

      } catch (err) {
        console.error('Error fetching weather:', err);
        showError('Unable to fetch weather. Check your connection.');
      } finally {
        setLoading(false);
      }
    }

    // Get weather by coordinates (for map clicks)
    async function getWeatherByCoords(lat, lng) {
      setLoading(true);
      errorMsg.classList.add('hidden');

      try {
        const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${apiKey}`);
        const data = await response.json();

        if (!response.ok) {
          showError(data.message || 'Location not found');
          setLoading(false);
          return;
        }

        // Update the UI with the new location's weather
        cityInput.value = data.name;
        getWeather(data.name);

      } catch (err) {
        console.error('Error fetching weather by coordinates:', err);
        showError('Unable to fetch weather. Check your connection.');
      } finally {
        setLoading(false);
      }
    }

    // Events
    searchForm.addEventListener('submit', e => {
      e.preventDefault();
      getWeather(cityInput.value);
    });

    clearBtn.addEventListener('click', () => {
      cityInput.value = '';
      cityInput.focus();
    });

    // Show/hide clear button based on input
    cityInput.addEventListener('input', () => {
      clearBtn.classList.toggle('hidden', !cityInput.value);
    });

    // Theme toggle (light/dark) with persistence
    let isLight = localStorage.getItem('weatherwiseTheme') === 'light';
    if (isLight) {
      document.documentElement.classList.add('light');
      themeIcon.classList.add('text-[var(--text-primary)]');
    }
    themeToggle.addEventListener('click', () => {
      isLight = !isLight;
      document.documentElement.classList.toggle('light', isLight);
      themeIcon.classList.toggle('text-[var(--text-primary)]', isLight);
      localStorage.setItem('weatherwiseTheme', isLight ? 'light' : 'dark');
      
      // Update map theme when theme changes
      updateMapTheme();
      
      // Reset background based on current weather when theme changes
      if (currentWeatherData) {
        const isDaytime = currentWeatherData.weather[0].icon.includes('d');
        setWeatherBackground(currentWeatherData.weather[0].main, currentWeatherData.main.temp, isDaytime);
      }
    });

    // Map layer toggle buttons
    mapTempBtn.addEventListener('click', () => {
      mapLayerType = 'temperature';
      mapTempBtn.classList.add('active');
      mapPrecipBtn.classList.remove('active');
      mapWindBtn.classList.remove('active');
      mapPressureBtn.classList.remove('active');
      // In a real implementation, you would update the map layer here
    });

    mapPrecipBtn.addEventListener('click', () => {
      mapLayerType = 'precipitation';
      mapTempBtn.classList.remove('active');
      mapPrecipBtn.classList.add('active');
      mapWindBtn.classList.remove('active');
      mapPressureBtn.classList.remove('active');
      // In a real implementation, you would update the map layer here
    });

    mapWindBtn.addEventListener('click', () => {
      mapLayerType = 'wind';
      mapTempBtn.classList.remove('active');
      mapPrecipBtn.classList.remove('active');
      mapWindBtn.classList.add('active');
      mapPressureBtn.classList.remove('active');
      // In a real implementation, you would update the map layer here
    });

    mapPressureBtn.addEventListener('click', () => {
      mapLayerType = 'pressure';
      mapTempBtn.classList.remove('active');
      mapPrecipBtn.classList.remove('active');
      mapWindBtn.classList.remove('active');
      mapPressureBtn.classList.add('active');
      // In a real implementation, you would update the map layer here
    });

    // Planner form submission
    plannerForm.addEventListener('submit', e => {
      e.preventDefault();
      
      const newPlan = {
        date: planDate.value,
        activity: planActivity.value,
        time: planTime.value
      };
      
      userPlans.push(newPlan);
      savePlans();
      renderPlans();
      
      // Reset form
      planActivity.value = '';
      planTime.value = '12:00';
      
      // Set date to tomorrow by default
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      planDate.value = tomorrow.toISOString().split('T')[0];
    });

    // Load more news
    loadMoreNews.addEventListener('click', async () => {
      loadMoreNews.textContent = 'Loading...';
      const moreNews = await fetchWeatherNews();
      displayWeatherNews([...newsContainer.children, ...moreNews]);
      loadMoreNews.textContent = 'Load More News';
    });

    // Initialize scroll animations
    initScrollAnimations();

    // Initialize map
    initMap();

    // Initialize 3D weather visualization
    init3DWeather();

    // Initialize planner
    function initPlanner() {
      // Set date to tomorrow by default
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      planDate.value = tomorrow.toISOString().split('T')[0];
      
      // Set time to 12:00 by default
      planTime.value = '12:00';
      
      // Render existing plans
      renderPlans();
    }
    initPlanner();

    // Fetch initial weather news
    fetchWeatherNews().then(news => displayWeatherNews(news));

    // Add window resize listener for Three.js
    window.addEventListener('resize', onWindowResize);

    // Load last searched city if present
    const lastCity = localStorage.getItem('weatherwiseLastCity');
    // Initial load
    getWeather(lastCity || 'Sunnyvale');
  </script>

</body>
</html>